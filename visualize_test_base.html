<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼‚å¸¸æ£€æµ‹å¯è§†åŒ– v5 (å¸¦ç»Ÿè®¡å¤§ç›˜)</title>
    <style>
        :root { 
            --gt-color: #22c55e; 
            --gt-fill: rgba(34, 197, 94, 0.25);
            --pred-color: #ef4444; 
            --pred-fill: rgba(239, 68, 68, 0.25);
            --bg: #f8f9fa; 
            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: #1f2937; }
        .container { max-width: 1800px; margin: 0 auto; }
        
        /* é¡¶éƒ¨åŒºåŸŸ */
        .header { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 25px; display: flex; flex-direction: column; gap: 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        .title h1 { margin: 0; font-size: 26px; color: #111827; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .legend { display: flex; gap: 15px; font-size: 14px; font-weight: 600; margin-top: 5px; color: #4b5563; }
        .dot { width: 12px; height: 12px; display: inline-block; border-radius: 3px; margin-right: 6px; }

        /* --- æ–°å¢ï¼šç»Ÿè®¡ä»ªè¡¨ç›˜ --- */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding-top: 10px;
            border-top: 1px solid #f3f4f6;
        }
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .stat-card .label { font-size: 13px; color: #64748b; font-weight: 600; margin-bottom: 5px; }
        .stat-card .value { font-size: 24px; font-weight: 700; color: #0f172a; }
        .stat-card .sub { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        .stat-highlight { color: #2563eb !important; }
        .stat-success { color: #16a34a !important; }
        .stat-danger { color: #dc2626 !important; }

        /* æ§åˆ¶æ  */
        .control-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; background: #f1f5f9; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .input-group { display: flex; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .input-group input { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px 0 0 6px; width: 220px; outline: none; }
        .input-group button { padding: 8px 16px; background: #4f46e5; color: white; border: none; border-radius: 0 6px 6px 0; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        .input-group button:hover { background: #4338ca; }
        
        .path-fixer { display: flex; align-items: center; gap: 10px; flex: 1; }
        .path-fixer input { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: monospace; font-size: 13px; }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(850px, 1fr)); 
            gap: 30px; 
        }
        .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: var(--card-shadow); border: 1px solid #e5e7eb; display: flex; flex-direction: column; }
        
        .card-header { padding: 12px 20px; background: #fff; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .header-id { font-size: 16px; font-weight: 700; color: #374151; }
        
        .metrics-pill { display: flex; gap: 10px; }
        .metric-tag { padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: 600; border: 1px solid transparent; }
        .tag-iou { background: #f0f9ff; color: #0284c7; border-color: #bae6fd; }
        .tag-ok { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .tag-err { background: #fee2e2; color: #991b1b; border-color: #fecaca; }

        .images-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #e2e8f0; }
        .img-wrapper { position: relative; background: #0f172a; min-height: 400px; max-height: 700px; display: flex; align-items: center; justify-content: center; }
        .img-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .img-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 10; }
        canvas.overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        .info-section { padding: 20px; font-size: 14px; background: #fff; border-top: 1px solid #f1f5f9; }
        .json-box { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-family: 'Consolas', monospace; max-height: 120px; overflow-y: auto; white-space: pre-wrap; font-size: 12px; color: #334155; margin-top: 5px; }
        .thinking-box { color: #64748b; font-style: italic; border-left: 3px solid #cbd5e1; padding: 10px; margin-top: 10px; background: #f9fafb; display: none; white-space: pre-wrap; }

        .pagination { margin-top: 40px; display: flex; justify-content: center; gap: 15px; padding-bottom: 60px; }
        .pagination button { padding: 10px 20px; background: white; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 15px; }
        .pagination button:hover { background: #f1f5f9; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="top-row">
            <div class="title">
                <h1>ğŸ“Š å¼‚å¸¸æ£€æµ‹è¯„ä¼°base Visualizer </h1>
                <div class="legend">
                    <span><span class="dot" style="background: var(--gt-color);"></span>GT çœŸå€¼</span>
                    <span><span class="dot" style="background: var(--pred-color);"></span>Pred é¢„æµ‹</span>
                </div>
            </div>
            
            <div class="input-group">
                <input type="text" id="urlInput" value="test_results_base.json" placeholder="ç»“æœæ–‡ä»¶å (.json)">
                <button onclick="loadFromUrl()">é‡æ–°åŠ è½½æ•°æ®</button>
            </div>
        </div>

        <div class="stats-dashboard" id="statsDashboard">
            <div class="stat-card">
                <span class="label">æ€»æ ·æœ¬æ•°</span>
                <span class="value" id="st-total">-</span>
                <span class="sub">Total Samples</span>
            </div>
            <div class="stat-card">
                <span class="label">æ•´ä½“å‡†ç¡®ç‡ (Status)</span>
                <span class="value stat-highlight" id="st-acc">-</span>
                <span class="sub">Accuracy</span>
            </div>
            <div class="stat-card">
                <span class="label">æ­£å¸¸æ ·æœ¬åˆ¤æ–­</span>
                <span class="value stat-success" id="st-normal">-</span>
                <span class="sub" id="st-normal-sub">0/0 Correct</span>
            </div>
            <div class="stat-card">
                <span class="label">å¼‚å¸¸æ ·æœ¬åˆ¤æ–­</span>
                <span class="value stat-danger" id="st-anomaly">-</span>
                <span class="sub" id="st-anomaly-sub">0/0 Correct</span>
            </div>
            <div class="stat-card">
                <span class="label">å®šä½ Recall (IoU>0.5)</span>
                <span class="value stat-highlight" id="st-iou">-</span>
                <span class="sub">Among GT Anomalies</span>
            </div>
        </div>

        <div class="control-row">
            <div class="path-fixer">
                <label>ğŸ› ï¸ å›¾ç‰‡è·¯å¾„å‰ç¼€:</label>
                <input type="text" id="pathPrefix" value="dataset/å¤§æ¨¡å‹ä½œä¸šæ•°æ®é›†/MVTEC-AD/" oninput="renderPage()" placeholder="ä¾‹å¦‚: dataset/images/">
            </div>
            <select id="statusFilter" onchange="applyFilters()" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1;">
                <option value="all">æ˜¾ç¤ºå…¨éƒ¨</option>
                <option value="correct">âœ… åªçœ‹æ­£ç¡®</option>
                <option value="wrong">âŒ åªçœ‹é”™è¯¯</option>
                <option value="anomaly_only">âš ï¸ åªçœ‹å«å¼‚å¸¸æ ·æœ¬</option>
                <option value="high_iou">ğŸ¯ é«˜ IoU (>0.5)</option>
            </select>
            <span id="listStatsText" style="color: #64748b; font-size: 14px; margin-left: 10px;"></span>
        </div>
    </div>

    <div id="grid" class="grid">
        <div style="text-align: center; grid-column: 1/-1; padding: 60px; color: #9ca3af; font-size: 18px;">
            æ•°æ®åŠ è½½ä¸­...
        </div>
    </div>

    <div class="pagination" id="pagination" style="display:none">
        <button onclick="changePage(-1)">â¬…ï¸ ä¸Šä¸€é¡µ</button>
        <span id="pageInfo" style="line-height: 40px; font-weight:600; color:#475569;">1 / 1</span>
        <button onclick="changePage(1)">ä¸‹ä¸€é¡µ â¡ï¸</button>
    </div>
</div>

<script>
    let rawData = [];
    let filteredData = [];
    let summaryData = null; // å­˜å‚¨åç«¯è®¡ç®—çš„ç»Ÿè®¡ä¿¡æ¯
    let currentPage = 1;
    const pageSize = 5;

    async function loadFromUrl() {
        const filename = document.getElementById('urlInput').value.trim();
        const btn = document.querySelector('.input-group button');
        
        if (!filename) { alert("è¯·è¾“å…¥æ–‡ä»¶å"); return; }
        btn.innerText = "è¯»å–ä¸­..."; btn.disabled = true;

        try {
            const response = await fetch(filename + "?t=" + new Date().getTime());
            if (!response.ok) throw new Error(`æ–‡ä»¶æœªæ‰¾åˆ° (404)`);

            const text = await response.text();
            
            // --- æ™ºèƒ½è§£æé€»è¾‘ ---
            try {
                // å°è¯•è§£æä¸ºæ ‡å‡† JSON (æ–°æ ¼å¼)
                const json = JSON.parse(text);
                if (json.summary && json.data) {
                    summaryData = json.summary;
                    rawData = json.data;
                } else if (Array.isArray(json)) {
                    // æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯æ•°ç»„
                    rawData = json;
                    summaryData = null;
                } else {
                    // å¯èƒ½æ˜¯å•ä¸ªå¯¹è±¡ä½†æ ¼å¼ä¸å¯¹
                    rawData = [];
                }
            } catch (e) {
                // å°è¯•è§£æä¸º JSONL (æ—§æ ¼å¼å…¼å®¹)
                rawData = text.trim().split('\n').map(line => {
                    try { return JSON.parse(line); } catch { return null; }
                }).filter(x => x);
                summaryData = null;
            }

            if (rawData.length === 0) alert("æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯");
            
            // æ¸²æŸ“ç»Ÿè®¡é¢æ¿
            renderDashboard(summaryData, rawData);
            
            applyFilters();
        } catch (err) {
            alert("âŒ åŠ è½½å¤±è´¥: " + err.message);
            console.error(err);
        } finally {
            btn.innerText = "é‡æ–°åŠ è½½æ•°æ®"; btn.disabled = false;
        }
    }

    // å°†ç»Ÿè®¡æ•°æ®æ¸²æŸ“åˆ°é¡¶éƒ¨ Dashboard
    function renderDashboard(summary, data) {
        // å¦‚æœåç«¯æ²¡ä¼  summaryï¼Œæˆ‘ä»¬è‡ªå·±ç®€å•ç®—ä¸€ä¸‹
        let s = summary;
        if (!s) {
            const total = data.length;
            const correct = data.filter(d => d.metrics.status_correct).length;
            const anomalyGt = data.filter(d => d.gt.status === 'å¼‚å¸¸').length;
            const normalGt = total - anomalyGt;
            // ç®€å•æ¨¡æ‹Ÿ
            s = {
                total_samples: total,
                accuracy_all: correct / total,
                normal_count: normalGt,
                normal_acc: 0, // æš‚æ— æ³•ç²¾ç¡®æ‹†åˆ†ï¼Œæ˜¾ç¤º '-'
                anomaly_count: anomalyGt,
                anomaly_acc: 0,
                bbox_recall_iou05: 0
            };
        }

        // è¾…åŠ©å‡½æ•°ï¼šç™¾åˆ†æ¯”
        const pct = (val) => (val * 100).toFixed(1) + '%';

        document.getElementById('st-total').innerText = s.total_samples;
        document.getElementById('st-acc').innerText = pct(s.accuracy_all);
        
        document.getElementById('st-normal').innerText = s.normal_acc ? pct(s.normal_acc) : '-';
        document.getElementById('st-normal-sub').innerText = `Total Normal: ${s.normal_count}`;
        
        document.getElementById('st-anomaly').innerText = s.anomaly_acc ? pct(s.anomaly_acc) : '-';
        document.getElementById('st-anomaly-sub').innerText = `Total Anomaly: ${s.anomaly_count}`;
        
        document.getElementById('st-iou').innerText = s.bbox_recall_iou05 ? pct(s.bbox_recall_iou05) : '-';
    }

    function applyFilters() {
        const statusMode = document.getElementById('statusFilter').value;
        filteredData = rawData.filter(item => {
            if (statusMode === 'correct') return item.metrics.status_correct;
            if (statusMode === 'wrong') return !item.metrics.status_correct;
            if (statusMode === 'anomaly_only') return item.gt.status === 'å¼‚å¸¸' || item.pred.status === 'å¼‚å¸¸';
            if (statusMode === 'high_iou') return item.metrics.max_iou > 0.5;
            return true;
        });
        document.getElementById('listStatsText').innerText = `å½“å‰åˆ—è¡¨: ${filteredData.length} æ¡`;
        currentPage = 1;
        renderPage();
    }

    function getFixedPath(originalPath) {
        if (!originalPath) return "";
        // ç®€å•çš„æå–æ–‡ä»¶åé€»è¾‘ï¼Œé€‚é…ä¸åŒè·¯å¾„ç»“æ„
        const parts = originalPath.split('/');
        const filename = parts.pop();
        const category = parts.pop(); // å‡è®¾ä¸Šä¸€çº§æ˜¯ç±»åˆ«å
        
        // å°è¯•åŒ¹é…ç‰¹å®šçš„ç±»åˆ«æ–‡ä»¶å¤¹
        const match = originalPath.match(/\/(bottle|cable|leather|tile|capsule|carpet|grid|hazelnut|metal_nut|pill|screw|toothbrush|transistor|wood|zipper)\//);
        let cleanName = originalPath;
        if (match) {
            cleanName = originalPath.substring(match.index + 1);
        } else {
             // å¦‚æœæ²¡åŒ¹é…åˆ°ï¼Œå°±å°½é‡ç”¨æœ€åä¸¤çº§
             cleanName = category + '/' + filename;
        }

        const prefix = document.getElementById('pathPrefix').value.trim();
        const finalPrefix = prefix && !prefix.endsWith('/') ? prefix + '/' : prefix;
        return finalPrefix + cleanName;
    }

    function renderPage() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const start = (currentPage - 1) * pageSize;
        const pageItems = filteredData.slice(start, start + pageSize);

        if (pageItems.length === 0) {
            grid.innerHTML = '<div style="text-align:center; grid-column:1/-1; padding:40px; color:#64748b">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ ·æœ¬</div>';
            updatePagination();
            return;
        }

        pageItems.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            
            const imgA = getFixedPath(item.image_a);
            const imgB = getFixedPath(item.image_b);

            const isCorrect = item.metrics.status_correct;
            const iouVal = (item.metrics.max_iou * 100).toFixed(1);
            
            card.innerHTML = `
                <div class="card-header">
                    <span class="header-id">Sample ID: ${item.id}</span>
                    <div class="metrics-pill">
                        <span class="metric-tag tag-iou">IoU: ${iouVal}%</span>
                        <span class="metric-tag ${isCorrect ? 'tag-ok' : 'tag-err'}">
                            ${isCorrect ? 'Status Correct' : 'Status Wrong'}
                        </span>
                    </div>
                </div>
                <div class="images-row">
                    <div class="img-wrapper">
                        <div class="img-label">Reference</div>
                        <img src="${imgA}" loading="lazy" onerror="this.style.display='none';">
                    </div>
                    <div class="img-wrapper" id="wrapper-${item.id}">
                        <div class="img-label">Target (Green=GT, Red=Pred)</div>
                        <img src="${imgB}" id="img-${item.id}" loading="lazy" onerror="this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥'">
                        <canvas id="canvas-${item.id}" class="overlay"></canvas>
                    </div>
                </div>
                <div class="info-section">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <strong style="color:var(--gt-color)">GT: ${item.gt.status}</strong>
                            <div class="json-box" style="border-left: 3px solid var(--gt-color)">${formatChanges(item.gt.changes)}</div>
                        </div>
                        <div>
                            <strong style="color:var(--pred-color)">Pred: ${item.pred.status}</strong>
                            <div class="json-box" style="border-left: 3px solid var(--pred-color)">${formatChanges(item.pred.changes)}</div>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <span style="color:#4f46e5; cursor:pointer; font-weight:600; font-size:13px;" onclick="toggleThinking(this)">â–¶ æ˜¾ç¤º CoT æ€ç»´é“¾</span>
                        <div class="thinking-box">${item.thinking || 'No thinking data'}</div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            
            // ç»˜å›¾é€»è¾‘
            const imgEl = card.querySelector(`#img-${item.id}`);
            if (imgEl) {
                imgEl.onload = () => drawBoxes(item, imgEl, card.querySelector(`#canvas-${item.id}`));
                if (imgEl.complete && imgEl.naturalWidth > 0) drawBoxes(item, imgEl, card.querySelector(`#canvas-${item.id}`));
            }
        });

        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function toggleThinking(el) {
        const box = el.nextElementSibling;
        if (box.style.display === 'block') {
            box.style.display = 'none';
            el.innerText = 'â–¶ æ˜¾ç¤º CoT æ€ç»´é“¾';
        } else {
            box.style.display = 'block';
            el.innerText = 'â–¼ éšè— CoT æ€ç»´é“¾';
        }
    }

    function drawBoxes(item, img, canvas) {
        if (!img || !canvas || img.naturalWidth === 0) return;
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.font = "bold 24px Arial";

        const draw = (changes, strokeColor, fillColor, prefix) => {
            if (!changes || !Array.isArray(changes)) return;
            changes.forEach((ch, i) => {
                if (!ch.bbox) return;
                const [x1, y1, x2, y2] = ch.bbox;
                const w = x2 - x1, h = y2 - y1;
                
                // å¡«å……
                ctx.fillStyle = fillColor;
                ctx.fillRect(x1, y1, w, h);
                // è¾¹æ¡†
                ctx.lineWidth = 4;
                ctx.strokeStyle = strokeColor;
                ctx.strokeRect(x1, y1, w, h);
                // æ ‡ç­¾
                const txt = `${prefix}${i+1}`;
                const tm = ctx.measureText(txt);
                ctx.fillStyle = strokeColor;
                const ly = y1 > 30 ? y1 - 30 : y1;
                ctx.fillRect(x1, ly, tm.width + 10, 30);
                ctx.fillStyle = "white";
                ctx.fillText(txt, x1 + 5, ly + 24);
            });
        };

        draw(item.gt.changes, '#22c55e', 'rgba(34, 197, 94, 0.25)', 'GT');
        draw(item.pred.changes, '#ef4444', 'rgba(239, 68, 68, 0.25)', 'P');
    }

    function formatChanges(changes) {
        if (!changes || changes.length === 0) return "[]";
        return changes.map((c, i) => `#${i+1} [${c.bbox ? c.bbox.map(x=>Math.round(x)).join(',') : ''}] ${c.description}`).join('\n');
    }

    function changePage(delta) {
        const maxPage = Math.ceil(filteredData.length / pageSize);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= maxPage) {
            currentPage = newPage;
            renderPage();
        }
    }

    function updatePagination() {
        const maxPage = Math.ceil(filteredData.length / pageSize) || 1;
        document.getElementById('pagination').style.display = filteredData.length > 0 ? 'flex' : 'none';
        document.getElementById('pageInfo').innerText = `${currentPage} / ${maxPage}`;
        const btns = document.querySelectorAll('.pagination button');
        btns[0].disabled = currentPage === 1;
        btns[1].disabled = currentPage === maxPage;
    }

    // åˆå§‹åŒ–
    window.onload = loadFromUrl;
</script>

</body>
</html>